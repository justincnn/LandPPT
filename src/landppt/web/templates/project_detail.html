{% extends "base.html" %}

{% block title %}{{ project.title }} - é¡¹ç›®è¯¦æƒ… - LandPPT{% endblock %}

{% block extra_css %}
<style>
/* ç°ä»£åŒ–é¡¹ç›®è¯¦æƒ…é¡µé¢ */
.project-detail-hero {
    background: var(--glass-bg);
    backdrop-filter: blur(30px);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
    padding: var(--spacing-2xl) var(--spacing-lg);
    margin: calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg)) var(--spacing-2xl) calc(-1 * var(--spacing-lg));
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
}

.project-detail-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
        radial-gradient(circle at 20% 30%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(155, 89, 182, 0.1) 0%, transparent 50%);
    animation: projectDetailFloat 22s ease-in-out infinite;
}

@keyframes projectDetailFloat {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.02) rotate(-1deg); }
}

.project-detail-hero h2 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: var(--spacing-md);
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
    z-index: 1;
    letter-spacing: -0.02em;
}

.project-detail-hero p {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0;
    position: relative;
    z-index: 1;
    font-weight: 500;
}

.project-detail-hero code {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--border-radius-sm);
    font-family: 'Consolas', monospace;
    color: var(--text-primary);
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ç¾åŒ– */
.status-indicator {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2.5rem;
    margin-right: var(--spacing-xl);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    position: relative;
}

.status-indicator::before {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border-radius: 50%;
    background: linear-gradient(45deg, rgba(255,255,255,0.3), transparent);
    z-index: -1;
}

.status-indicator.completed {
    background: var(--success-gradient);
}

.status-indicator.in_progress {
    background: var(--accent-gradient);
}

.status-indicator.draft {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
}

.status-indicator.error {
    background: var(--secondary-gradient);
}

/* é¡¹ç›®ä¿¡æ¯å¡ç‰‡ç¾åŒ– */
.project-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    margin-bottom: var(--spacing-xl);
}

.project-info-item {
    text-align: center;
}

.project-info-item strong {
    display: block;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: var(--spacing-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.project-info-item p {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.1rem;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="project-detail-hero">
    <h2>{{ project.title }}</h2>
    <p>é¡¹ç›®ID: <code>{{ project.project_id }}</code></p>
</div>

<div style="max-width: 1400px; margin: 0 auto; padding: var(--spacing-lg);">`

<div class="grid">
    <!-- Project Information -->
    <div class="card">
        <h3 style="color: #3498db; margin-bottom: 15px;">ğŸ“‹ é¡¹ç›®ä¿¡æ¯</h3>
        
        <div style="margin-bottom: var(--spacing-xl);">
            <div style="display: flex; align-items: center; margin-bottom: var(--spacing-lg);">
                {% if project.status == 'completed' %}
                    <div class="status-indicator completed">
                        âœ…
                    </div>
                {% elif project.status == 'in_progress' %}
                    <div class="status-indicator in_progress">
                        ğŸ”„
                    </div>
                {% elif project.status == 'draft' %}
                    <div class="status-indicator draft">
                        ğŸ“
                    </div>
                {% else %}
                    <div class="status-indicator error">
                        âŒ
                    </div>
                {% endif %}
                
                <div>
                    {% if project.status == 'completed' %}
                        <h4 style="color: #2c3e50; margin-bottom: 5px;">é¡¹ç›®å·²å®Œæˆ</h4>
                        <p style="color: #7f8c8d; margin: 0;">æ‰€æœ‰é˜¶æ®µå·²å®Œæˆ</p>
                    {% elif project.status == 'in_progress' %}
                        {% if todo_board %}
                            {% set current_stage = todo_board.stages | selectattr('status', 'equalto', 'running') | first %}
                            {% if current_stage %}
                                <h4 style="color: #2c3e50; margin-bottom: 5px;">{{ current_stage.name }}ä¸­</h4>
                                <p style="color: #7f8c8d; margin: 0;">å½“å‰æ­£åœ¨æ‰§è¡Œ</p>
                            {% else %}
                                {% set next_stage = todo_board.stages | selectattr('status', 'equalto', 'pending') | first %}
                                {% if next_stage %}
                                    <h4 style="color: #2c3e50; margin-bottom: 5px;">ç­‰å¾…{{ next_stage.name }}</h4>
                                    <p style="color: #7f8c8d; margin: 0;">ä¸‹ä¸€ä¸ªé˜¶æ®µ</p>
                                {% else %}
                                    <h4 style="color: #2c3e50; margin-bottom: 5px;">é¡¹ç›®è¿›è¡Œä¸­</h4>
                                    <p style="color: #7f8c8d; margin: 0;">æ­£åœ¨å¤„ç†ä¸­</p>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <h4 style="color: #2c3e50; margin-bottom: 5px;">é¡¹ç›®è¿›è¡Œä¸­</h4>
                            <p style="color: #7f8c8d; margin: 0;">æ­£åœ¨å¤„ç†ä¸­</p>
                        {% endif %}
                    {% elif project.status == 'draft' %}
                        <h4 style="color: #2c3e50; margin-bottom: 5px;">è‰ç¨¿çŠ¶æ€</h4>
                        <p style="color: #7f8c8d; margin: 0;">ç­‰å¾…å¼€å§‹</p>
                    {% else %}
                        <h4 style="color: #2c3e50; margin-bottom: 5px;">{{ project.status | title }}</h4>
                        <p style="color: #7f8c8d; margin: 0;">å½“å‰é¡¹ç›®çŠ¶æ€</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="project-info-grid">
            <div class="project-info-item">
                <strong>ä¸»é¢˜</strong>
                <p>{{ project.topic }}</p>
            </div>
            <div class="project-info-item">
                <strong>åœºæ™¯</strong>
                <p>{{ project.scenario }}</p>
            </div>
            <div class="project-info-item">
                <strong>ç‰ˆæœ¬</strong>
                <p>v{{ project.version }}</p>
            </div>
            <div class="project-info-item">
                <strong>åˆ›å»ºæ—¶é—´</strong>
                <p>{{ project.created_at | strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
        </div>

        {% if project.requirements %}
        <div style="background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); padding: var(--spacing-xl); border-radius: var(--border-radius-lg); margin-bottom: var(--spacing-xl);">
            <strong style="color: var(--text-secondary); display: block; margin-bottom: var(--spacing-md); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9rem;">ç‰¹æ®Šè¦æ±‚</strong>
            <p style="color: var(--text-primary); margin: 0; line-height: 1.6; font-size: 1.1rem;">{{ project.requirements }}</p>
        </div>
        {% endif %}
        
        <!-- Project Actions -->
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            {% if project.status == 'in_progress' and todo_board %}
            <a href="/projects/{{ project.project_id }}/todo" class="btn btn-primary" style="flex: 1;">
                ğŸ“‹ TODO çœ‹æ¿
            </a>
            {% endif %}

            {% if project.status == 'completed' and project.slides_html %}
            <a href="/projects/{{ project.project_id }}/fullscreen" class="btn btn-success" target="_blank" style="flex: 1;">
                ğŸ” é¢„è§ˆ PPT
            </a>
            {% endif %}
            
            <button onclick="archiveProject()" class="btn btn-warning" style="flex: 1;">
                ğŸ“¦ å½’æ¡£é¡¹ç›®
            </button>
            
            <button onclick="deleteProject()" class="btn btn-danger" style="flex: 1;">
                ğŸ—‘ï¸ åˆ é™¤é¡¹ç›®
            </button>
        </div>
    </div>
    
    <!-- TODO Board Progress -->
    {% if todo_board %}
    <div class="card">
        <h3 style="color: #27ae60; margin-bottom: 15px;">ğŸ“ˆ è¿›åº¦æ¦‚è§ˆ</h3>
        
        <div style="margin-bottom: 20px;">
            <div style="background: #ecf0f1; border-radius: 15px; overflow: hidden; height: 20px;">
                <div style="background: linear-gradient(90deg, #27ae60, #2ecc71); height: 100%; width: {{ todo_board.overall_progress }}%; transition: width 0.5s ease; border-radius: 15px;"></div>
            </div>
            <p style="text-align: center; margin-top: 10px; color: #2c3e50; font-weight: bold;">
                æ€»ä½“è¿›åº¦: {{ "%.1f" | format(todo_board.overall_progress) }}%
            </p>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <h4 style="color: #2c3e50; margin-bottom: 10px;">é˜¶æ®µçŠ¶æ€</h4>
            {% for stage in todo_board.stages %}
            <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="margin-right: 15px;">
                    {% if stage.status == 'completed' %}
                        <span style="color: #27ae60; font-size: 1.2em;">âœ…</span>
                    {% elif stage.status == 'running' %}
                        <span style="color: #3498db; font-size: 1.2em;">ğŸ”„</span>
                    {% elif stage.status == 'failed' %}
                        <span style="color: #e74c3c; font-size: 1.2em;">âŒ</span>
                    {% else %}
                        <span style="color: #95a5a6; font-size: 1.2em;">â³</span>
                    {% endif %}
                </div>
                <div style="flex: 1;">
                    <strong style="color: #2c3e50; font-size: 0.9em;">{{ stage.name }}</strong>
                    <p style="color: #7f8c8d; font-size: 0.8em; margin: 2px 0 0 0;">{{ stage.description }}</p>
                    {% if stage.status == 'running' and stage.progress is defined %}
                    <div style="background: #ecf0f1; border-radius: 5px; overflow: hidden; height: 4px; margin-top: 5px;">
                        <div style="background: #3498db; height: 100%; width: {{ stage.progress }}%; transition: width 0.3s ease;"></div>
                    </div>
                    {% endif %}
                </div>
                <div style="margin-left: 15px;">
                    {% if stage.status == 'pending' %}
                        {% if stage.id == 'requirements_confirmation' %}
                            <a href="/projects/{{ project.project_id }}/todo" class="btn btn-primary" style="font-size: 0.8em; padding: 6px 12px;">
                                <i class="fas fa-play"></i> å¼€å§‹
                            </a>
                        {% elif stage.id == 'outline_generation' %}
                            <a href="/projects/{{ project.project_id }}/todo" class="btn btn-primary" style="font-size: 0.8em; padding: 6px 12px;">
                                <i class="fas fa-brain"></i> ç”Ÿæˆå¤§çº²
                            </a>
                        {% elif stage.id == 'ppt_creation' %}
                            <a href="/projects/{{ project.project_id }}/todo" class="btn btn-primary" style="font-size: 0.8em; padding: 6px 12px;">
                                <i class="fas fa-magic"></i> ç”ŸæˆPPT
                            </a>
                        {% else %}
                            <a href="/projects/{{ project.project_id }}/todo" class="btn btn-primary" style="font-size: 0.8em; padding: 6px 12px;">
                                <i class="fas fa-play"></i> å¼€å§‹
                            </a>
                        {% endif %}
                    {% elif stage.status == 'running' %}
                        <a href="/projects/{{ project.project_id }}/todo" class="btn btn-info" style="font-size: 0.8em; padding: 6px 12px;">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹è¿›åº¦
                        </a>
                    {% elif stage.status == 'completed' %}
                        <a href="/projects/{{ project.project_id }}/todo" class="btn btn-success" style="font-size: 0.8em; padding: 6px 12px;">
                            <i class="fas fa-check"></i> å·²å®Œæˆ
                        </a>
                    {% elif stage.status == 'failed' %}
                        <a href="/projects/{{ project.project_id }}/todo" class="btn btn-warning" style="font-size: 0.8em; padding: 6px 12px;">
                            <i class="fas fa-redo"></i> é‡è¯•
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- PPT Outline Preview -->
{% if project.outline and project.outline is not none and project.outline.get('slides') %}
<div style="margin-top: 40px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #2c3e50; margin: 0;">ğŸ“„ PPT å¤§çº²</h3>
        <div style="display: flex; gap: 10px;">
            <button onclick="toggleOutlineView()" class="btn btn-info" style="font-size: 0.9em;">
                <i class="fas fa-eye"></i> <span id="viewToggleText">è¯¦ç»†è§†å›¾</span>
            </button>
            <button onclick="editOutline()" class="btn btn-primary" style="font-size: 0.9em;">
                <i class="fas fa-edit"></i> ä¿®æ”¹å¤§çº²
            </button>
            <button onclick="exportOutlineJSON()" class="btn btn-success" style="font-size: 0.9em;">
                <i class="fas fa-download"></i> å¯¼å‡ºJSON
            </button>
        </div>
    </div>

    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
        <div style="text-align: center; margin-bottom: 20px;">
            <h4 style="color: #3498db; margin-bottom: 10px;">{{ project.outline.get('title', project.topic or 'æœªå‘½åå¤§çº²') }}</h4>
            <p style="color: #7f8c8d;">
                æ€»å…± {{ project.outline.get('slides', [])|length }} é¡µå¹»ç¯ç‰‡ |
                åœºæ™¯: {{ project.outline.get('metadata', {}).get('scenario', project.scenario) }} |
                è¯­è¨€: {{ project.outline.get('metadata', {}).get('language', 'zh') }}
            </p>
        </div>

        <!-- ç®€æ´è§†å›¾ -->
        <div id="compactView" style="display: block;">
            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    {% for slide in project.outline.get('slides', []) %}
                    <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #3498db; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                            <button onclick="editSingleSlide({{ loop.index0 }})" class="btn btn-primary" style="font-size: 0.7em; padding: 4px 8px; border-radius: 4px;" title="ç¼–è¾‘æ­¤é¡µ">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="viewSlideDetail({{ loop.index0 }})" class="btn btn-info" style="font-size: 0.7em; padding: 4px 8px; border-radius: 4px;" title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <div onclick="viewSlideDetail({{ loop.index0 }})" style="cursor: pointer; margin-right: 60px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #3498db; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; margin-right: 10px;">
                                    {{ slide.get('page_number', loop.index) }}
                                </span>
                                <strong style="color: #2c3e50; font-size: 0.9em;">{{ slide.get('title', 'æœªå‘½åå¹»ç¯ç‰‡') }}</strong>
                            </div>
                            {% if slide.get('subtitle') %}
                            <p style="color: #7f8c8d; font-size: 0.8em; margin: 5px 0; font-style: italic;">{{ slide.get('subtitle') }}</p>
                            {% endif %}
                            <div style="color: #666; font-size: 0.8em; line-height: 1.4;">
                                {% if slide.get('content_points') and slide.get('content_points')|length > 0 %}
                                    {{ slide.get('content_points')[0][:80] }}{% if slide.get('content_points')[0]|length > 80 %}...{% endif %}
                                    {% if slide.get('content_points')|length > 1 %}
                                    <br><span style="color: #95a5a6;">+{{ slide.get('content_points')|length - 1 }} ä¸ªè¦ç‚¹</span>
                                    {% endif %}
                                {% elif slide.get('content') %}
                                    {{ slide.get('content')[:80] }}{% if slide.get('content')|length > 80 %}...{% endif %}
                                {% else %}
                                    <span style="color: #95a5a6;">æš‚æ— å†…å®¹</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†è§†å›¾ -->
        <div id="detailView" style="display: none; max-height: 500px; overflow-y: auto;">
            {% for slide in project.outline.get('slides', []) %}
            <div style="padding: 20px; margin-bottom: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #3498db; position: relative;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span style="background: #3498db; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">
                        {{ slide.get('page_number', loop.index) }}
                    </span>
                    <div style="flex: 1;">
                        <strong style="color: #2c3e50; font-size: 1.1em;">{{ slide.get('title', 'æœªå‘½åå¹»ç¯ç‰‡') }}</strong>
                        {% if slide.get('subtitle') %}
                        <br><em style="color: #7f8c8d; font-size: 0.9em;">{{ slide.get('subtitle') }}</em>
                        {% endif %}
                    </div>
                    <button onclick="editSingleSlide({{ loop.index0 }})" class="btn btn-primary" style="font-size: 0.8em; padding: 6px 12px;" title="ç¼–è¾‘æ­¤é¡µ">
                        <i class="fas fa-edit"></i> ç¼–è¾‘
                    </button>
                </div>

                {% if slide.get('content_points') %}
                <div style="margin-top: 10px;">
                    <h5 style="color: #555; margin-bottom: 8px; font-size: 0.9em;">å†…å®¹è¦ç‚¹ï¼š</h5>
                    <ul style="margin: 0; padding-left: 20px; color: #555; line-height: 1.6;">
                        {% for point in slide.get('content_points', []) %}
                        <li style="margin-bottom: 5px;">{{ point }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% elif slide.get('content') %}
                <div style="margin-top: 10px;">
                    <h5 style="color: #555; margin-bottom: 8px; font-size: 0.9em;">å†…å®¹ï¼š</h5>
                    <div style="background: white; padding: 15px; border-radius: 6px; color: #555; line-height: 1.6; white-space: pre-wrap;">{{ slide.get('content') }}</div>
                </div>
                {% endif %}

                {% if slide.get('slide_type') %}
                <div style="margin-top: 10px;">
                    <span style="background: #e8f4fd; color: #3498db; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                        ç±»å‹: {{ slide.get('slide_type') }}
                    </span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% elif project.outline and project.outline is not none %}
<!-- Show outline content if it exists but doesn't have slides structure -->
<div style="margin-top: 40px;">
    <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸ“„ PPT å¤§çº²</h3>

    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
        <div style="text-align: center; margin-bottom: 20px;">
            <h4 style="color: #3498db; margin-bottom: 10px;">{{ project.outline.get('title', project.topic or 'æœªå‘½åå¤§çº²') if project.outline else (project.topic or 'æœªå‘½åå¤§çº²') }}</h4>
            <p style="color: #7f8c8d;">å¤§çº²å†…å®¹</p>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
            {% if project.outline and project.outline.get('content') %}
            <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; margin: 0;">{{ project.outline.get('content') }}</pre>
            {% else %}
            <p style="color: #7f8c8d; text-align: center; margin: 0;">å¤§çº²å†…å®¹æ­£åœ¨ç”Ÿæˆä¸­...</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Version History -->
{% if versions %}
<div style="margin-top: 40px;">
    <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸ“š ç‰ˆæœ¬å†å²</h3>
    
    <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
        {% for version in versions %}
        <div style="display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px;">
            <div style="margin-right: 20px;">
                <div style="width: 40px; height: 40px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                    v{{ version.version }}
                </div>
            </div>
            
            <div style="flex: 1;">
                <strong style="color: #2c3e50;">{{ version.description }}</strong>
                <p style="color: #7f8c8d; margin: 5px 0 0 0; font-size: 0.9em;">
                    {{ version.timestamp | strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
            </div>
            
            <div style="margin-left: 15px;">
                <button onclick="restoreVersion({{ version.version }})" class="btn btn-primary" style="font-size: 0.9em;">
                    ğŸ”„ æ¢å¤æ­¤ç‰ˆæœ¬
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Navigation -->
<div style="text-align: center; margin-top: 40px;">
    <a href="/projects" class="btn" style="background: #95a5a6; margin: 0 10px;">
        ğŸ“‹ è¿”å›é¡¹ç›®åˆ—è¡¨
    </a>
    <a href="/dashboard" class="btn btn-primary" style="margin: 0 10px;">
        ğŸ“Š é¡¹ç›®ä»ªè¡¨æ¿
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
const projectId = '{{ project.project_id }}';
const projectOutline = {{ project.outline | tojson if project.outline else 'null' }};
const projectSlides = {{ project.outline.get('slides', []) | tojson if project.outline else '[]' }};

async function archiveProject() {
    if (confirm('ç¡®å®šè¦å½’æ¡£è¿™ä¸ªé¡¹ç›®å—ï¼Ÿå½’æ¡£åé¡¹ç›®å°†ä¸ä¼šæ˜¾ç¤ºåœ¨æ´»è·ƒé¡¹ç›®åˆ—è¡¨ä¸­ã€‚')) {
        try {
            const response = await fetch(`/api/projects/${projectId}/archive`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                alert('é¡¹ç›®å·²å½’æ¡£');
                window.location.href = '/projects';
            } else {
                alert('å½’æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('Error archiving project:', error);
            alert('å½’æ¡£å¤±è´¥: ' + error.message);
        }
    }
}

async function deleteProject() {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        if (confirm('è¯·å†æ¬¡ç¡®è®¤åˆ é™¤æ“ä½œï¼Œæ‰€æœ‰æ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼')) {
            try {
                // Show loading indicator
                const deleteBtn = document.querySelector('button[onclick="deleteProject()"]');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = 'ğŸ”„ åˆ é™¤ä¸­...';
                deleteBtn.disabled = true;

                const response = await fetch(`/api/database/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert('é¡¹ç›®åˆ é™¤æˆåŠŸï¼');
                    window.location.href = '/projects';
                } else {
                    throw new Error(result.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);

                // Restore button state
                const deleteBtn = document.querySelector('button[onclick="deleteProject()"]');
                deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤é¡¹ç›®';
                deleteBtn.disabled = false;
            }
        }
    }
}

// å¤§çº²è§†å›¾åˆ‡æ¢
let isDetailView = false;

function toggleOutlineView() {
    const compactView = document.getElementById('compactView');
    const detailView = document.getElementById('detailView');
    const toggleText = document.getElementById('viewToggleText');

    if (isDetailView) {
        compactView.style.display = 'block';
        detailView.style.display = 'none';
        toggleText.textContent = 'è¯¦ç»†è§†å›¾';
        isDetailView = false;
    } else {
        compactView.style.display = 'none';
        detailView.style.display = 'block';
        toggleText.textContent = 'ç®€æ´è§†å›¾';
        isDetailView = true;
    }
}

// æŸ¥çœ‹å¹»ç¯ç‰‡è¯¦æƒ…
function viewSlideDetail(slideIndex) {
    const slide = projectSlides[slideIndex];

    if (!slide) return;

    // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
        align-items: center; justify-content: center; padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 30px;
        max-width: 600px; max-height: 80vh; overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;

    let contentPoints = '';
    if (slide.content_points && slide.content_points.length > 0) {
        contentPoints = '<h5 style="color: #555; margin: 15px 0 8px 0;">å†…å®¹è¦ç‚¹ï¼š</h5><ul style="margin: 0; padding-left: 20px; color: #555; line-height: 1.6;">';
        slide.content_points.forEach(point => {
            contentPoints += `<li style="margin-bottom: 5px;">${point}</li>`;
        });
        contentPoints += '</ul>';
    } else if (slide.content) {
        contentPoints = `<h5 style="color: #555; margin: 15px 0 8px 0;">å†…å®¹ï¼š</h5><div style="background: #f8f9fa; padding: 15px; border-radius: 6px; color: #555; line-height: 1.6; white-space: pre-wrap;">${slide.content}</div>`;
    }

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin: 0;">ç¬¬${slide.page_number || slideIndex + 1}é¡µè¯¦æƒ…</h3>
            <button onclick="this.closest('.modal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">Ã—</button>
        </div>
        <h4 style="color: #3498db; margin-bottom: 10px;">${slide.title || 'æœªå‘½åå¹»ç¯ç‰‡'}</h4>
        ${slide.subtitle ? `<p style="color: #7f8c8d; font-style: italic; margin-bottom: 15px;">${slide.subtitle}</p>` : ''}
        ${contentPoints}
        ${slide.slide_type ? `<div style="margin-top: 15px;"><span style="background: #e8f4fd; color: #3498db; padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">ç±»å‹: ${slide.slide_type}</span></div>` : ''}
    `;

    modal.className = 'modal';
    modal.appendChild(content);
    document.body.appendChild(modal);

    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// ç¼–è¾‘å¤§çº²
function editOutline() {
    if (!projectOutline) {
        alert('å¤§çº²æ•°æ®ä¸å­˜åœ¨ï¼Œæ— æ³•ç¼–è¾‘');
        return;
    }

    // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
        align-items: center; justify-content: center; padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 30px;
        width: 90%; max-width: 800px; height: 80vh; display: flex;
        flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin: 0;">ç¼–è¾‘PPTå¤§çº²</h3>
            <button onclick="this.closest('.modal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">Ã—</button>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column;">
            <textarea id="outlineEditor" style="flex: 1; border: 2px solid #ecf0f1; border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: none;" placeholder="ç¼–è¾‘å¤§çº²JSON...">${JSON.stringify(projectOutline, null, 2)}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: space-between;">
                <button onclick="aiOptimizeFullOutlineInProjectDetail()" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <i class="fas fa-robot"></i> ä¼˜åŒ–å¤§çº²
                </button>
                <div style="display: flex; gap: 10px;">
                    <button onclick="this.closest('.modal').remove()" class="btn" style="background: #95a5a6;">å–æ¶ˆ</button>
                    <button onclick="saveOutlineChanges()" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    `;

    modal.className = 'modal';
    modal.appendChild(content);
    document.body.appendChild(modal);
}

// ä¿å­˜å¤§çº²ä¿®æ”¹
async function saveOutlineChanges() {
    const editor = document.getElementById('outlineEditor');
    try {
        const newOutline = JSON.parse(editor.value);

        const response = await fetch(`/projects/${projectId}/update-outline`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ outline_content: JSON.stringify(newOutline, null, 2) })
        });

        if (response.ok) {
            alert('å¤§çº²ä¿®æ”¹æˆåŠŸï¼');
            window.location.reload();
        } else {
            const error = await response.json();
            alert('ä¿å­˜å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        if (error instanceof SyntaxError) {
            alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•ï¼');
        } else {
            console.error('Error saving outline:', error);
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    }
}

// å¯¼å‡ºå¤§çº²ä¸ºJSONæ–‡ä»¶
function exportOutlineJSON() {
    if (!projectOutline) {
        alert('å¤§çº²æ•°æ®ä¸å­˜åœ¨ï¼Œæ— æ³•å¯¼å‡º');
        return;
    }

    const dataStr = JSON.stringify(projectOutline, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${(projectOutline.title || 'ppt_outline')}_${new Date().toISOString().split('T')[0]}.json`;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: #27ae60;
        color: white; padding: 15px 20px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001;
        font-size: 14px; font-weight: bold;
    `;
    toast.textContent = 'âœ… å¤§çº²JSONæ–‡ä»¶å·²å¯¼å‡º';
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ç¼–è¾‘å•é¡µå¹»ç¯ç‰‡
function editSingleSlide(slideIndex) {
    if (!projectSlides || !projectSlides[slideIndex]) {
        alert('å¹»ç¯ç‰‡ä¸å­˜åœ¨');
        return;
    }

    const slide = projectSlides[slideIndex];

    // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
        align-items: center; justify-content: center; padding: 20px;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 30px;
        width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;

    // æ„å»ºå†…å®¹è¦ç‚¹çš„ç¼–è¾‘ç•Œé¢
    let contentPointsHtml = '<h5 style="color: #555; margin: 15px 0 8px 0;">å†…å®¹è¦ç‚¹ï¼š</h5>';
    contentPointsHtml += '<div id="contentPointsContainer">';

    if (slide.content_points && slide.content_points.length > 0) {
        slide.content_points.forEach((point, index) => {
            contentPointsHtml += `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <input type="text" id="point_${index}" value="${point.replace(/"/g, '&quot;')}"
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;">
                    <button onclick="removeContentPoint(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer;">åˆ é™¤</button>
                </div>
            `;
        });
    }

    contentPointsHtml += '</div>';
    contentPointsHtml += `
        <button onclick="addContentPoint()" style="background: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-top: 10px;">
            + æ·»åŠ è¦ç‚¹
        </button>
    `;

    content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; margin: 0;">ç¼–è¾‘ç¬¬${slide.page_number || slideIndex + 1}é¡µ</h3>
            <button onclick="this.closest('.modal').remove()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">Ã—</button>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: bold;">æ ‡é¢˜ï¼š</label>
            <input type="text" id="slideTitle" value="${slide.title || ''}"
                   style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: bold;">å‰¯æ ‡é¢˜ï¼š</label>
            <input type="text" id="slideSubtitle" value="${slide.subtitle || ''}"
                   style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: bold;">å¹»ç¯ç‰‡ç±»å‹ï¼š</label>
            <select id="slideType" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px;">
                <option value="content" ${slide.slide_type === 'content' ? 'selected' : ''}>å†…å®¹é¡µ</option>
                <option value="title" ${slide.slide_type === 'title' ? 'selected' : ''}>æ ‡é¢˜é¡µ</option>
                <option value="conclusion" ${slide.slide_type === 'conclusion' ? 'selected' : ''}>ç»“è®ºé¡µ</option>
            </select>
        </div>

        <div id="contentPointsSection" style="margin-bottom: 20px;">
            ${contentPointsHtml}
        </div>

        ${slide.content ? `
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: bold;">å†…å®¹ï¼š</label>
            <textarea id="slideContent" rows="4"
                      style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px; resize: vertical;">${slide.content}</textarea>
        </div>
        ` : ''}

        <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 20px;">
            <button onclick="aiOptimizeSingleSlideInProjectDetail(${slideIndex})" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <i class="fas fa-robot"></i> AIä¼˜åŒ–
            </button>
            <div style="display: flex; gap: 10px;">
                <button onclick="this.closest('.modal').remove()" class="btn" style="background: #95a5a6;">å–æ¶ˆ</button>
                <button onclick="saveSingleSlideChanges(${slideIndex})" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    `;

    modal.className = 'modal';
    modal.appendChild(content);
    document.body.appendChild(modal);

    // å­˜å‚¨å½“å‰ç¼–è¾‘çš„å¹»ç¯ç‰‡ç´¢å¼•
    window.currentEditingSlideIndex = slideIndex;
}

// æ·»åŠ å†…å®¹è¦ç‚¹
function addContentPoint() {
    // æŸ¥æ‰¾å†…å®¹è¦ç‚¹å®¹å™¨
    const container = document.getElementById('contentPointsContainer');

    if (!container) {
        console.error('æ‰¾ä¸åˆ°å†…å®¹è¦ç‚¹å®¹å™¨');
        alert('æ— æ³•æ‰¾åˆ°å†…å®¹è¦ç‚¹å®¹å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }

    // è®¡ç®—å½“å‰è¦ç‚¹æ•°é‡
    const existingPoints = document.querySelectorAll('input[id^="point_"]');
    const pointIndex = existingPoints.length;

    const pointDiv = document.createElement('div');
    pointDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px;';
    pointDiv.innerHTML = `
        <input type="text" id="point_${pointIndex}" placeholder="è¾“å…¥è¦ç‚¹å†…å®¹..."
               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;">
        <button onclick="removeContentPoint(${pointIndex})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer;">åˆ é™¤</button>
    `;

    // ç›´æ¥æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
    container.appendChild(pointDiv);
}

// åˆ é™¤å†…å®¹è¦ç‚¹
function removeContentPoint(index) {
    const pointElement = document.getElementById(`point_${index}`);
    if (pointElement) {
        pointElement.closest('div').remove();
    }
}

// ä¿å­˜å•é¡µå¹»ç¯ç‰‡ä¿®æ”¹
async function saveSingleSlideChanges(slideIndex) {
    try {
        const title = document.getElementById('slideTitle').value.trim();
        const subtitle = document.getElementById('slideSubtitle').value.trim();
        const slideType = document.getElementById('slideType').value;
        const content = document.getElementById('slideContent')?.value.trim() || '';

        // æ”¶é›†æ‰€æœ‰å†…å®¹è¦ç‚¹
        const contentPoints = [];
        const pointInputs = document.querySelectorAll('input[id^="point_"]');
        pointInputs.forEach(input => {
            const value = input.value.trim();
            if (value) {
                contentPoints.push(value);
            }
        });

        if (!title) {
            alert('è¯·è¾“å…¥å¹»ç¯ç‰‡æ ‡é¢˜');
            return;
        }

        // æ„å»ºæ›´æ–°çš„å¹»ç¯ç‰‡æ•°æ®
        const updatedSlide = {
            ...projectSlides[slideIndex],
            title: title,
            subtitle: subtitle || undefined,
            slide_type: slideType,
            content_points: contentPoints.length > 0 ? contentPoints : undefined,
            content: content || undefined
        };

        // æ›´æ–°æœ¬åœ°æ•°æ®
        projectSlides[slideIndex] = updatedSlide;

        // æ›´æ–°å¤§çº²ä¸­çš„å¹»ç¯ç‰‡
        if (!projectOutline) {
            alert('å¤§çº²æ•°æ®ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿å­˜ä¿®æ”¹');
            return;
        }
        const updatedOutline = { ...projectOutline };
        updatedOutline.slides[slideIndex] = updatedSlide;

        // å‘é€åˆ°æœåŠ¡å™¨
        const response = await fetch(`/projects/${projectId}/update-outline`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ outline_content: JSON.stringify(updatedOutline, null, 2) })
        });

        if (response.ok) {
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.modal').remove();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60;
                color: white; padding: 15px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001;
                font-size: 14px; font-weight: bold;
            `;
            toast.textContent = `âœ… ç¬¬${slideIndex + 1}é¡µä¿®æ”¹æˆåŠŸ`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°
                window.location.reload();
            }, 2000);
        } else {
            const error = await response.json();
            alert('ä¿å­˜å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Error saving slide changes:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

async function restoreVersion(version) {
    if (confirm(`ç¡®å®šè¦æ¢å¤åˆ°ç‰ˆæœ¬ v${version} å—ï¼Ÿå½“å‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚`)) {
        try {
            const response = await fetch(`/api/projects/${projectId}/versions/${version}/restore`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                alert('ç‰ˆæœ¬æ¢å¤æˆåŠŸ');
                window.location.reload();
            } else {
                alert('ç‰ˆæœ¬æ¢å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } catch (error) {
            console.error('Error restoring version:', error);
            alert('ç‰ˆæœ¬æ¢å¤å¤±è´¥: ' + error.message);
        }
    }
}

// ========== AIä¼˜åŒ–åŠŸèƒ½ ==========

// åˆ›å»ºç¾åŒ–çš„AIä¼˜åŒ–éœ€æ±‚è¾“å…¥å¼¹çª—
function showAIOptimizeModal(config) {
    return new Promise((resolve, reject) => {
        // åˆ›å»ºæ¨¡æ€æ¡†é®ç½©
        const modal = document.createElement('div');
        modal.className = 'ai-optimize-modal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            padding: 20px; animation: fadeIn 0.3s ease;
        `;

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const content = document.createElement('div');
        content.style.cssText = `
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px; padding: 0; max-width: 600px; width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease; max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
        `;

        // å»ºè®®ç¤ºä¾‹
        const suggestions = config.suggestions || [
            'å¢åŠ æ›´å¤šæ–‡å­—è¯´æ˜',
            'ç®€åŒ–å†…å®¹ï¼Œçªå‡ºæ ¸å¿ƒè¦ç‚¹',
            'æ·»åŠ æ•°æ®æ”¯æ’‘å’Œæ¡ˆä¾‹åˆ†æ',
            'ä¼˜åŒ–é€»è¾‘ç»“æ„ï¼Œå¢å¼ºè¯´æœåŠ›',
            'å¢åŠ è§†è§‰åŒ–æè¿°å»ºè®®'
        ];

        content.innerHTML = `
            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-50px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                .ai-optimize-modal .suggestion-tag {
                    display: inline-block;
                    padding: 6px 12px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    border-radius: 20px;
                    font-size: 12px;
                    margin: 4px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid transparent;
                }
                .ai-optimize-modal .suggestion-tag:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    border-color: #667eea;
                    background: linear-gradient(135deg, #764ba2, #667eea);
                }
                .ai-optimize-modal textarea:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }
            </style>
            
            <!-- å¤´éƒ¨ -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; position: relative;">
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 100 100\\"><defs><pattern id=\\"dots\\" width=\\"20\\" height=\\"20\\" patternUnits=\\"userSpaceOnUse\\"><circle cx=\\"10\\" cy=\\"10\\" r=\\"1\\" fill=\\"white\\" opacity=\\"0.1\\"/></pattern></defs><rect width=\\"100\\" height=\\"100\\" fill=\\"url(%23dots)\\"/></svg></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; font-size: 1.3em; font-weight: 700;">
                                <i class="fas fa-magic" style="margin-right: 10px;"></i>${config.title}
                            </h3>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">${config.subtitle}</p>
                        </div>
                        <button onclick="this.closest('.ai-optimize-modal').remove()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 20px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div style="padding: 30px; flex: 1; overflow-y: auto;">
                <!-- å½“å‰ä¿¡æ¯å±•ç¤º -->
                <div style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="color: #2c3e50; font-size: 0.9em; line-height: 1.6;">
                        <strong style="color: #3498db;"><i class="fas fa-info-circle"></i> å½“å‰å†…å®¹</strong><br>
                        ${config.currentInfo}
                    </div>
                </div>

                <!-- è¾“å…¥æ¡† -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: #2c3e50; font-weight: 600; font-size: 0.95em;">
                        <i class="fas fa-edit"></i> è¯·æè¿°æ‚¨çš„ä¼˜åŒ–éœ€æ±‚
                    </label>
                    <textarea id="aiOptimizeInput" style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 14px; resize: vertical; font-family: inherit; transition: all 0.3s ease;" placeholder="è¯¦ç»†æè¿°æ‚¨å¸Œæœ›å¦‚ä½•ä¼˜åŒ–æ­¤å†…å®¹...

ä¾‹å¦‚ï¼š
- å¢åŠ æ›´å¤šæŠ€æœ¯ç»†èŠ‚
- é‡æ–°ç»„ç»‡é€»è¾‘ç»“æ„
- æ·»åŠ æ¡ˆä¾‹åˆ†æ"></textarea>
                </div>

                <!-- å¿«æ·å»ºè®® -->
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 10px; color: #7f8c8d; font-size: 0.85em;">
                        <i class="fas fa-lightbulb"></i> ç‚¹å‡»å¿«æ·å»ºè®®å¿«é€Ÿå¡«å……
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${suggestions.map(s => `<span class="suggestion-tag" onclick="document.getElementById('aiOptimizeInput').value = '${s}'">${s}</span>`).join('')}
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰é’® -->
            <div style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 20px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e9ecef;">
                <div style="color: #7f8c8d; font-size: 0.85em;">
                    <i class="fas fa-robot"></i> AIå°†æ ¹æ®æ‚¨çš„éœ€æ±‚æ™ºèƒ½ä¼˜åŒ–å†…å®¹
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="this.closest('.ai-optimize-modal').remove()" class="btn btn-sm" style="background: #95a5a6; color: white; padding: 10px 20px;">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button id="confirmOptimizeBtn" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 24px;">
                        <i class="fas fa-magic"></i> å¼€å§‹ä¼˜åŒ–
                    </button>
                </div>
            </div>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
            const input = document.getElementById('aiOptimizeInput');
            if (input) input.focus();
        }, 100);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                reject('ç”¨æˆ·å–æ¶ˆ');
            }
        });

        // ç¡®è®¤æŒ‰é’®
        const confirmBtn = document.getElementById('confirmOptimizeBtn');
        confirmBtn.onclick = () => {
            const input = document.getElementById('aiOptimizeInput');
            const value = input?.value.trim();
            if (!value) {
                // è¾“å…¥æ¡†æŠ–åŠ¨åŠ¨ç”»
                input.style.animation = 'shake 0.5s';
                setTimeout(() => { input.style.animation = ''; }, 500);
                return;
            }
            modal.remove();
            resolve(value);
        };

        // æ·»åŠ shakeåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);
    });
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–æ­£ç¡®çš„ç›®æ ‡å—ä¼—ï¼ˆå¤„ç†è‡ªå®šä¹‰å—ä¼—æƒ…å†µï¼‰
function getTargetAudience(outline) {
    if (!outline || !outline.metadata) {
        return 'æ™®é€šå¤§ä¼—';
    }
    const audienceType = outline.metadata.target_audience;
    // å¦‚æœé€‰æ‹©çš„æ˜¯"è‡ªå®šä¹‰"ï¼Œåˆ™ä½¿ç”¨custom_audienceå­—æ®µçš„å€¼
    if (audienceType === 'è‡ªå®šä¹‰' && outline.metadata.custom_audience) {
        return outline.metadata.custom_audience;
    }
    return audienceType || 'æ™®é€šå¤§ä¼—';
}

// AIä¼˜åŒ–æ•´ä¸ªå¤§çº²
async function aiOptimizeFullOutlineInProjectDetail() {
    const editor = document.getElementById('outlineEditor');
    if (!editor || !editor.value) {
        alert('è¯·å…ˆè¾“å…¥å¤§çº²JSONå†…å®¹');
        return;
    }

    // éªŒè¯JSONæ ¼å¼
    let parsedOutline;
    try {
        parsedOutline = JSON.parse(editor.value);
    } catch (e) {
        alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·å…ˆä¿®æ­£æ ¼å¼åå†è¿›è¡ŒAIä¼˜åŒ–');
        return;
    }

    // æ˜¾ç¤ºç¾åŒ–çš„ä¼˜åŒ–éœ€æ±‚è¾“å…¥å¼¹çª—
    let userRequest;
    try {
        userRequest = await showAIOptimizeModal({
            title: 'ä¼˜åŒ–å¤§çº²',
            subtitle: 'è®©AIå¸®åŠ©æ‚¨ä¼˜åŒ–æ•´ä¸ªPPTå¤§çº²ç»“æ„å’Œå†…å®¹',
            currentInfo: `<strong>å¤§çº²æ ‡é¢˜ï¼š</strong>${parsedOutline.title}<br><strong>å¹»ç¯ç‰‡æ•°é‡ï¼š</strong>${parsedOutline.slides ? parsedOutline.slides.length : 0} é¡µ<br><strong>åœºæ™¯ï¼š</strong>${parsedOutline.metadata?.scenario || 'é€šç”¨'}`,
            suggestions: [
                'å¢åŠ æ›´å¤šæ–‡å­—è¯´æ˜å’ŒæŠ€æœ¯ç»†èŠ‚',
                'é‡æ–°ç»„ç»‡ç»“æ„ï¼Œä¼˜åŒ–é€»è¾‘æµç¨‹',
                'çªå‡ºåˆ›æ–°ç‚¹å’Œäº®ç‚¹å†…å®¹',
                'å¢å¼ºå„é¡µé¢ä¹‹é—´çš„è¿è´¯æ€§',
                'è°ƒæ•´é¡µæ•°ï¼Œä½¿å†…å®¹æ›´è¯¦ç»†'
            ]
        });
    } catch (e) {
        return; // ç”¨æˆ·å–æ¶ˆ
    }

    if (!userRequest || !userRequest.trim()) {
        return;
    }

    // æ˜¾ç¤ºåŠ è½½æç¤º
    const loadingToast = document.createElement('div');
    loadingToast.id = 'ai-optimize-loading';
    loadingToast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2);
        color: white; padding: 15px 20px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001;
        font-size: 14px; font-weight: bold;
    `;
    loadingToast.innerHTML = `<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨ä¼˜åŒ–æ•´ä¸ªå¤§çº²...`;
    document.body.appendChild(loadingToast);

    try {
        // è°ƒç”¨AIä¼˜åŒ–æ¥å£
        const response = await fetch('/api/ai/optimize-outline', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                outline_content: editor.value,
                user_request: userRequest.trim(),
                project_info: {
                    topic: parsedOutline.title || 'æœªçŸ¥',
                    scenario: parsedOutline.metadata?.scenario || 'é€šç”¨',
                    target_audience: getTargetAudience(parsedOutline)
                },
                optimization_type: 'full'
            })
        });

        const result = await response.json();
        loadingToast.remove();

        if (result.success && result.optimized_content) {
            // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
            editor.value = result.optimized_content;
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const successToast = document.createElement('div');
            successToast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60;
                color: white; padding: 15px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001;
                font-size: 14px; font-weight: bold;
            `;
            successToast.innerHTML = `âœ… AIä¼˜åŒ–å®Œæˆ<br><small style="font-weight: normal;">è¯·æ£€æŸ¥ä¼˜åŒ–ç»“æœï¼Œæ»¡æ„åç‚¹å‡»"ä¿å­˜ä¿®æ”¹"</small>`;
            document.body.appendChild(successToast);

            setTimeout(() => {
                successToast.remove();
            }, 5000);

        } else {
            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';
            if (result.extracted_json) {
                console.error('æå–çš„JSON:', result.extracted_json);
                errorMsg += '\n\nè¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚';
            }
            if (result.raw_response) {
                console.error('AIåŸå§‹å“åº”:', result.raw_response);
            }
            alert('AIä¼˜åŒ–å¤±è´¥:\n' + errorMsg);
        }

    } catch (error) {
        console.error('AIä¼˜åŒ–å¤±è´¥:', error);
        const loadingToast = document.getElementById('ai-optimize-loading');
        if (loadingToast) loadingToast.remove();
        alert('AIä¼˜åŒ–å¤±è´¥: ' + error.message);
    }
}

// AIä¼˜åŒ–å•é¡µå¹»ç¯ç‰‡
async function aiOptimizeSingleSlideInProjectDetail(slideIndex) {
    // ä»è¡¨å•ä¸­è·å–å½“å‰æ•°æ®
    const title = document.getElementById('slideTitle')?.value.trim() || '';
    const subtitle = document.getElementById('slideSubtitle')?.value.trim() || '';
    const slideType = document.getElementById('slideType')?.value || 'content';
    
    // è·å–æ‰€æœ‰å†…å®¹è¦ç‚¹
    const contentPointInputs = document.querySelectorAll('input[id^="point_"]');
    const contentPoints = Array.from(contentPointInputs)
        .map(input => input.value.trim())
        .filter(point => point.length > 0);

    if (!title) {
        alert('è¯·å…ˆè¾“å…¥é¡µé¢æ ‡é¢˜');
        return;
    }

    // æ˜¾ç¤ºç¾åŒ–çš„ä¼˜åŒ–éœ€æ±‚è¾“å…¥å¼¹çª—
    let userRequest;
    try {
        userRequest = await showAIOptimizeModal({
            title: `AIä¼˜åŒ– - ç¬¬${slideIndex + 1}é¡µ`,
            subtitle: 'è®©AIå¸®åŠ©æ‚¨ä¼˜åŒ–è¿™ä¸€é¡µçš„å†…å®¹',
            currentInfo: `<strong>æ ‡é¢˜ï¼š</strong>${title}<br>${subtitle ? `<strong>å‰¯æ ‡é¢˜ï¼š</strong>${subtitle}<br>` : ''}<strong>ç±»å‹ï¼š</strong>${slideType}<br><strong>å†…å®¹è¦ç‚¹ï¼š</strong>${contentPoints.length}ä¸ª`,
            suggestions: [
                'å¢åŠ æ›´å¤šæŠ€æœ¯ç»†èŠ‚å’Œå®ä¾‹',
                'ç®€åŒ–å†…å®¹ï¼Œçªå‡ºæ ¸å¿ƒè¦ç‚¹',
                'ä¼˜åŒ–é€»è¾‘ç»“æ„ï¼Œä½¿å†…å®¹æ›´è¿è´¯',
                'å¢å¼ºè¯´æœåŠ›ï¼Œæ·»åŠ æ•°æ®æ”¯æ’‘',
                'ä¸°å¯Œè¡¨è¾¾æ–¹å¼ï¼Œæå‡ä¸“ä¸šåº¦'
            ]
        });
    } catch (e) {
        return; // ç”¨æˆ·å–æ¶ˆ
    }

    if (!userRequest || !userRequest.trim()) {
        return;
    }

    // æ˜¾ç¤ºåŠ è½½æç¤º
    const loadingToast = document.createElement('div');
    loadingToast.id = 'ai-optimize-loading';
    loadingToast.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2);
        color: white; padding: 15px 20px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001;
        font-size: 14px; font-weight: bold;
    `;
    loadingToast.innerHTML = `<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨ä¼˜åŒ–ç¬¬${slideIndex + 1}é¡µ...`;
    document.body.appendChild(loadingToast);

    try {
        // ä½¿ç”¨é¡¹ç›®å¤§çº²æ•°æ®
        if (!projectOutline || !projectOutline.slides) {
            throw new Error('å¤§çº²æ•°æ®ä¸å­˜åœ¨');
        }

        const outlineContent = JSON.stringify(projectOutline);

        // è°ƒç”¨AIä¼˜åŒ–æ¥å£
        const response = await fetch('/api/ai/optimize-outline', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                outline_content: outlineContent,
                user_request: userRequest.trim(),
                project_info: {
                    topic: projectOutline.title || 'æœªçŸ¥',
                    scenario: projectOutline.metadata?.scenario || 'é€šç”¨',
                    target_audience: getTargetAudience(projectOutline)
                },
                optimization_type: 'single',
                slide_index: slideIndex
            })
        });

        const result = await response.json();
        loadingToast.remove();

        if (result.success && result.optimized_content) {
            // è§£æä¼˜åŒ–åçš„å•é¡µæ•°æ®
            const optimizedSlide = JSON.parse(result.optimized_content);
            
            // æ›´æ–°å¼¹çª—ä¸­çš„è¡¨å•
            document.getElementById('slideTitle').value = optimizedSlide.title || '';
            document.getElementById('slideSubtitle').value = optimizedSlide.subtitle || '';
            document.getElementById('slideType').value = optimizedSlide.slide_type || 'content';
            
            // æ›´æ–°å†…å®¹è¦ç‚¹
            const container = document.getElementById('contentPointsContainer');
            if (container) {
                container.innerHTML = '';
                if (optimizedSlide.content_points && optimizedSlide.content_points.length > 0) {
                    optimizedSlide.content_points.forEach((point, idx) => {
                        const pointDiv = document.createElement('div');
                        pointDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px;';
                        pointDiv.innerHTML = `
                            <input type="text" id="point_${idx}" value="${point.replace(/"/g, '&quot;')}"
                                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 8px;">
                            <button onclick="removeContentPoint(${idx})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer;">åˆ é™¤</button>
                        `;
                        container.appendChild(pointDiv);
                    });
                }
            }
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const successToast = document.createElement('div');
            successToast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #27ae60;
                color: white; padding: 15px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001;
                font-size: 14px; font-weight: bold;
            `;
            successToast.textContent = `âœ… AIä¼˜åŒ–å®Œæˆï¼Œè¯·æ£€æŸ¥åä¿å­˜`;
            document.body.appendChild(successToast);

            setTimeout(() => {
                successToast.remove();
            }, 3000);

        } else {
            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';
            if (result.extracted_json) {
                console.error('æå–çš„JSON:', result.extracted_json);
                errorMsg += '\n\nè¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚';
            }
            if (result.raw_response) {
                console.error('AIåŸå§‹å“åº”:', result.raw_response);
            }
            alert('AIä¼˜åŒ–å¤±è´¥:\n' + errorMsg);
        }

    } catch (error) {
        console.error('AIä¼˜åŒ–å¤±è´¥:', error);
        const loadingToast = document.getElementById('ai-optimize-loading');
        if (loadingToast) loadingToast.remove();
        alert('AIä¼˜åŒ–å¤±è´¥: ' + error.message);
    }
}

</script>
{% endblock %}
